# 优惠券推送
#### 背景
* 用户数量大（千万/百万【带标签的用户 eg:会员】）
1. 批量查询或分批次查询消耗内存
2. 大数据量写mq耗时
3. 发券，瞬时高并发写Mysql压力大

<hr/>

#### 方案1 事件驱动（将耗时操作解耦）（多台机器增加消费能力）（单台机器多线程性能达到极致）
1. 优惠券系统：运营人员 创建优惠券活动 发送活动事件到MQ 返回活动开始成功(不阻塞活动发起)
2. 优惠券系统：
    * 消费活动事件消息，
    * 查用户调用会员系统查询用户总数构造消息（分批次 eg:1w用户，batch:100,count:100）->msg:{count:1w,startId:0,endId:100},
    * 发送到MQ,消息会均匀放到topic下的各个Queue中
3. 推送系统（多实例）：
   * 均匀消费到各个queue中的消息去调用会员系统，根据startId,endId查询出具体的用户id,
   * 多线程（单台机器性能用到极致），去构造消息，来调用消息通知平台(eg:短信,消息,App) # 30-50-80线程数，评估维度：推送效率，cpu 50-80%，带宽几乎达到极致但没被打满

4. 不合理之处：
   * 大批量查用户
   * 给每个用户构造消息

<hr>

#### 方案2 惰性发券
1. 优惠券系统：运营人员 创建优惠券活动 记录活动到Redis
2. 账号系统：用户登录（或访问） 发送mq 
3. 推送系统：消费用户登录消息，去查redis有没有收到优惠券消息，可以使用bitmap进行过滤，没有收到则构造消息进行推送

